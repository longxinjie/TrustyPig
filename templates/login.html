<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Login â€“ Welcome Back, TrustyPig!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}" />
</head>
<body class="fade-in">
  <div class="split-container">
    <!-- Left Panel -->
    <div class="left-panel">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="SMU FinWallet Logo" style="width: 350px; margin-bottom: 20px;" />
      <p style="color: white; text-align: center; margin-top: 20px;">
        A Smart, Secure and Simple Digital Wallet with
        <a href="/what-is-fraud-sight" style="color: white;">Built-in Fraud Protection.</a>
      </p>
      <lottie-player
          src="{{ url_for('static', filename='login.json') }}"
          background="transparent"
          speed="1"
          style="width: 300px; height: 300px;"
          loop
          autoplay>
      </lottie-player>
    </div>

    <!-- Right Panel -->
    <div class="right-panel">
      <div class="form-container">
        <div id="step1">
          <h2>Welcome Back ðŸ‘‹</h2>
          <div class="input-row">
        <input type="tel" id="phone" placeholder="Mobile Number" required />
        <button onclick="sendOTP()">Send OTP</button>
        </div>
        <div id="recaptcha-container"></div>
        </div>

        <div id="step2" class="hidden">
            <p class="message" id="otp-message" style="margin-bottom: 10px;"></p>
          <div class="input-row">
        <input type="text" id="otp" placeholder="Enter OTP" />
        <button onclick="verifyOTP()">Verify OTP</button>
        </div>
        </div>

        <div class="register-link">
          Don't have an account? <a href="/register">Register</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>

<script>
  const firebaseConfig = {{ firebase_config | tojson}};
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
    size: 'normal'
  });

  function sendOTP() {
    let phoneNumber = document.getElementById("phone").value.trim();
    if (!phoneNumber.startsWith("+")) {
      phoneNumber = "+65" + phoneNumber;
    }
    if (!/^\+\d{9,15}$/.test(phoneNumber)) {
      Swal.fire('Invalid Phone', 'Please enter a valid number (e.g., +6591234567)', 'error');
      return;
    }
    auth.signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier)
      .then(confirmationResult => {
        window.confirmationResult = confirmationResult;
        document.getElementById("recaptcha-container").style.display = "none";
        document.getElementById("step2").classList.remove("hidden");
        document.getElementById("otp-message").textContent = `OTP sent to ${phoneNumber}`;
      })
      .catch(error => {
        Swal.fire('Error', error.message, 'error');
      });
  }

  function verifyOTP() {
    const code = document.getElementById("otp").value.trim();
    if (!code) return;

    window.confirmationResult.confirm(code)
      .then(() => {
        document.body.classList.add("fade-out");
        setTimeout(() => {
          window.location.href = "/home";
        }, 600);
      })
      .catch(() => {
        Swal.fire('Invalid OTP', 'Please try again.', 'error');
      });
  }
</script>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>

</body>
</html>
